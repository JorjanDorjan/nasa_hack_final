<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Exoplanetas{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Nexa body font (fallbacks) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700;900&display=swap" rel="stylesheet">
    {% block head %}{% endblock %}
    <script>
      // Basic TTS controls available to all pages
      let speechUtterance = null;
      let speechActive = false;
      const PAGE_TRANSITION_MS = 300;
      function toggleTTS() {
        const selection = document.getSelection().toString().trim();
        const textToRead = selection || document.body.innerText;
        if (!speechActive) {
          if (speechSynthesis.speaking) { speechSynthesis.cancel(); }
          speechUtterance = new SpeechSynthesisUtterance(textToRead);
          speechUtterance.lang = 'es-ES';
          speechUtterance.onend = () => { speechActive = false; updateTTSState(); };
          speechSynthesis.speak(speechUtterance);
          speechActive = true;
        } else {
          speechSynthesis.cancel();
          speechActive = false;
        }
        updateTTSState();
      }
      // Page transition helpers
      function navigate(url){
        document.body.classList.add('page-leave');
        window.setTimeout(()=>{ window.location.href = url; }, PAGE_TRANSITION_MS);
      }
      document.addEventListener('DOMContentLoaded', () => {
        // Trigger page enter animation
        requestAnimationFrame(()=> document.body.classList.add('page-enter'));
        // Intercept normal anchor clicks (same tab)
        document.body.addEventListener('click', (e) => {
          const a = e.target.closest('a');
          if (!a) return;
          const href = a.getAttribute('href');
          const target = a.getAttribute('target');
          if (!href || href.startsWith('#') || target === '_blank') return;
          if (a.dataset.noTransition === 'true') return;
          // Allow default for external links
          const isExternal = /^(https?:)?\/\//i.test(href);
          if (isExternal) return;
          e.preventDefault();
          navigate(href);
        }, { capture: true });
      });
      function updateTTSState(){
        const btn = document.getElementById('btn-tts');
        if (!btn) return;
        btn.setAttribute('aria-pressed', speechActive ? 'true' : 'false');
        btn.title = speechActive ? 'Detener lectura' : 'Escuchar lectura';
      }
      function goBack(){
        if (document.referrer) { window.history.back(); } else { window.location.href = '{{ url_for('portada') }}'; }
      }
      function toggleSideMenu(){
        document.body.classList.toggle('menu-open');
      }
      function toggleAIChat(){
        document.body.classList.toggle('chat-open');
      }
    </script>
</head>
<body>
    <header class="topbar">
        <div class="brand" onclick="window.location='{{ url_for('portada') }}'">Exoplanetas</div>
        <form class="quick-search" action="{{ url_for('buscar') }}" method="get">
            <input type="text" name="q" placeholder="Buscar exoplaneta..." aria-label="Buscar exoplaneta">
            <button type="submit">Buscar</button>
        </form>
        <nav class="top-actions">
            <a href="{{ url_for('portada') }}">Inicio</a>
            <a href="{{ url_for('menu_principal') }}">Men√∫</a>
            <a href="{{ url_for('contenidos') }}">Contenidos</a>
            <a class="herramienta-link" href="{{ url_for('herramienta') }}">Herramienta</a>
            <a href="#">Contacto</a>
            <a href="#">Ingresar</a>
            <a href="#">Registro</a>
        </nav>
    </header>

    <!-- Slide-out menu content for small screens -->
    <aside class="side-menu" aria-hidden="true">
        <button class="close" onclick="toggleSideMenu()" aria-label="Cerrar men√∫">√ó</button>
        <ul>
            <li><a href="{{ url_for('menu_principal') }}">Men√∫ principal</a></li>
            <li><a href="{{ url_for('contenidos') }}">Contenidos</a></li>
            <li><a href="{{ url_for('buscar') }}">Herramienta de b√∫squeda</a></li>
            <li><a href="{{ url_for('identificador') }}">Identificador de exoplanetas</a></li>
        </ul>
    </aside>

    <!-- AI Chat panel -->
    <section class="ai-chat" aria-hidden="true">
        <header>
            <h2>Asistente</h2>
            <button onclick="toggleAIChat()" aria-label="Cerrar chat">√ó</button>
        </header>
        <div class="chat-quick">
            <button>¬øC√≥mo funciona la p√°gina?</button>
            <button>¬øC√≥mo usar la herramienta de b√∫squeda?</button>
            <button>Problemas para escuchar la lectura</button>
            <button>M√°s informaci√≥n</button>
            <button>Ayuda</button>
        </div>
        <div class="chat-window">
            <div class="messages" id="chat-messages"></div>
            <form class="composer" onsubmit="event.preventDefault();">
                <input type="text" placeholder="Escribe tu pregunta...">
                <button type="submit">Enviar</button>
            </form>
        </div>
    </section>

    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Floating controls -->
    <button class="fab fab-back" onclick="goBack()" title="Regresar" aria-label="Regresar">‚Üê</button>
    <button class="fab fab-menu" onclick="toggleSideMenu()" title="Abrir men√∫" aria-label="Abrir men√∫">‚â°</button>
    <button id="btn-tts" class="fab fab-tts" onclick="toggleTTS()" title="Escuchar lectura" aria-label="Escuchar lectura">üîä</button>
    <button class="fab fab-ai" onclick="toggleAIChat()" title="Asistente" aria-label="Asistente">üë®‚ÄçüöÄ</button>

    {% block scripts %}
    <script>
      // Identificador: trigger background scan on input changes
      document.addEventListener('input', (e) => {
        const t = e.target;
        if (!(t instanceof HTMLInputElement)) return;
        if (!t.classList.contains('scan-trigger')) return;
        const section = t.closest('.identificador-page');
        if (!section) return;
        section.classList.add('scanning');
        setTimeout(()=> section.classList.remove('scanning'), 450);
      });
    </script>
    {% endblock %}
</body>
</html>

